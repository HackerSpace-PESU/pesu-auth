name: PyTest

on: [ push, pull_request ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 5
      matrix:
        python-version: [ "3.9", "3.10", "3.11", "3.12" ]

    env:
      TEST_PRN: ${{ secrets.TEST_PRN }}
      TEST_SRN: ${{ secrets.TEST_SRN }}
      TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      TEST_BRANCH: ${{ secrets.TEST_BRANCH }}
      TEST_BRANCH_SHORT_CODE: ${{ secrets.TEST_BRANCH_SHORT_CODE }}
      TEST_PROGRAM: ${{ secrets.TEST_PROGRAM }}
      TEST_SEMESTER: ${{ secrets.TEST_SEMESTER }}
      TEST_SECTION: ${{ secrets.TEST_SECTION }}
      TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
      TEST_PHONE: ${{ secrets.TEST_PHONE }}
      TEST_CAMPUS: ${{ secrets.TEST_CAMPUS }}
      TEST_CAMPUS_CODE: ${{ secrets.TEST_CAMPUS_CODE }}
      # TEST_CLASS: ${{ secrets.TEST_CLASS }}
      # TEST_CYCLE: ${{ secrets.TEST_CYCLE }}
      # TEST_DEPARTMENT: ${{ secrets.TEST_DEPARTMENT }}
      # TEST_INSTITUTE_NAME: ${{ secrets.TEST_INSTITUTE_NAME }}

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov httpx

    - name: Run tests with pytest
      run: |
        echo "PRN = $TEST_PRN"
        echo "PASSWORD = $TEST_PASSWORD"
        echo "CAMPUS_CODE = $TEST_CAMPUS_CODE"
        echo "CAMPUS = $TEST_CAMPUS"
        echo "SEMESTER = $TEST_SEMESTER"
        echo "SECTION = $TEST_SECTION"
        echo "PROGRAM = $TEST_PROGRAM"
        echo "BRANCH = $TEST_BRANCH"
        echo "BRANCH_SHORT_CODE = $TEST_BRANCH_SHORT_CODE"
        echo "EMAIL = $TEST_EMAIL"
        echo "PHONE = $TEST_PHONE"
        echo "Running tests..."
        pytest --cov=app --cov-report=term-missing --cov-fail-under=80 --disable-warnings -v
